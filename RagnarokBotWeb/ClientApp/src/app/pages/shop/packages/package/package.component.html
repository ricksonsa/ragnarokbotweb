<nz-space nzSize="middle">
  <button (click)="goBack()" *nzSpaceItem nz-button nzType="default">
    <nz-icon nzType="arrow-left"></nz-icon>
    Packages
  </button>
  <button *nzSpaceItem [disabled]="!packageForm.value.id" nz-popconfirm nz-button nzType="default" nzDanger="true"
    nzPopconfirmTitle="Are you sure you want to delete this item?" (nzOnConfirm)="confirmDelete(packageForm.value.id)"
    (nzOnCancel)="cancelDelete()" nzPopconfirmPlacement="topLeft" [nzOkText]="'Yes'" nzCancelText="No"
    [nzOkDanger]="true">
    <nz-icon nzType="delete"></nz-icon>
    Delete
  </button>
  <button *nzSpaceItem nz-button nzType="primary" (click)="save()" [nzLoading]="loading">
    Save Package
  </button>
</nz-space>
<br>
<br>
<div class="main">
  <nz-card nzTitle="Package">
    <form nz-form [formGroup]="packageForm">
      <nz-form-item>
        <nz-form-label [nzSpan]="0" nzFor="name">Name*</nz-form-label>
        <nz-form-control [nzSpan]="24" nzErrorTip="Please input the package name!">
          <input formControlName="name" nz-input name="name" type="text" id="name" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="0" nzFor="description">Description*</nz-form-label>
        <nz-form-control [nzSpan]="24" nzErrorTip="Please input the package description!">
          <textarea formControlName="description" nz-input name="description" type="text" id="description"></textarea>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item nzAlign="middle">
        <nz-form-label [nzSpan]="0" nzFor="enabled">Enabled</nz-form-label>
        <nz-form-control [nzSpan]="2">
          <label nz-checkbox formControlName="enabled"></label>
        </nz-form-control>
        <p nz-typography nzType="secondary" style="margin: 0;">Determine whether this package will be available for
          purchase. Disabled packages won't show up in the Discord Channel</p>
      </nz-form-item>


      <nz-form-item>
        <nz-form-label [nzSpan]="0" nzFor="packageImage">Package Image</nz-form-label>
        <nz-form-control [nzSpan]="24" [nzExtra]="uploadBtn">
          <img *ngIf="avatarUrl" nz-image width="200px" height="200px"
            [nzSrc]="!isUploaded ? avatarUrl : 'http://localhost:8080/' + avatarUrl" alt="" />
          <ng-template #uploadBtn>
            <nz-upload nzAction="https://www.mocky.io/v2/5cc8019d300000980a055e76"
              [nzBeforeUpload]="handleBeforeUpload">
              <button style="display: none;" #upload></button>
            </nz-upload>

            <button nz-button (click)="upload.click()">
              <nz-icon nzType="upload" />
              Upload
            </button>
            <button *ngIf="packageForm.value.imageUrl != null" style="margin-left: 1px;" nz-button nzDanger
              (click)="removeImage()">
              Remove
            </button>
          </ng-template>

        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="0" nzFor="discordChannelId">Discord Channel</nz-form-label>
        <nz-form-control [nzSpan]="24" [nzExtra]="discordChannelExtra">
          <nz-select formControlName="discordChannelId" id="discordChannelId"
            nzPlaceHolder="Select the discord channel in which this package will be displayed for purchase">
            <nz-option *ngFor="let ch of channels" [nzValue]="ch.discordId" [nzLabel]="ch.name"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <ng-template #discordChannelExtra>
        <p *ngIf="account?.server?.discord">The discord channel in which this package will be displayed for
          purchase.</p>
        <span *ngIf="!account?.server?.discord">
          <nz-alert nzType="warning" [nzMessage]="discordInstalledMessage"></nz-alert>
          <ng-template #discordInstalledMessage>
            <div class="discord-success">
              <nz-icon nzType="discord" nzTheme="fill" style="font-size: 40px; color: #7289da;" />
              <div>
                <p style="margin: 0;">Discord server is not configured.</p>
                <p style="margin: 0;"><a [routerLink]="'/servers/' + account?.serverId + '/settings/discord'">Click
                    here</a> and follow the instructions to set up the discord server.</p>
              </div>
            </div>
          </ng-template>
        </span>
      </ng-template>

      <nz-form-item>
        <nz-form-label [nzSpan]="0" nzFor="price">Price</nz-form-label>
        <nz-form-control [nzSpan]="24" nzErrorTip="Please input the package price!">
          <input formControlName="price" nz-input name="price" type="number" id="price" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="0" nzFor="vipPrice">VIP Price</nz-form-label>
        <nz-form-control [nzSpan]="24">
          <input formControlName="vipPrice" nz-input name="vipPrice" type="number" id="vipPrice" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item nzAlign="middle">
        <nz-form-label [nzSpan]="0" nzFor="isVipOnly">VIP Only</nz-form-label>
        <nz-form-control [nzSpan]="2">
          <label nz-checkbox formControlName="isVipOnly"></label>
        </nz-form-control>
        <p nz-typography style="margin: 0;" nzType="secondary">Determine whether this package will only be available for
          VIP Players.</p>
      </nz-form-item>

      <nz-form-item nzAlign="middle">
        <nz-form-label [nzSpan]="0" nzFor="isBlockPurchaseRaidTime">Block Purchase During Raid Times</nz-form-label>
        <nz-form-control [nzSpan]="2">
          <label nz-checkbox formControlName="isBlockPurchaseRaidTime"></label>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="0" nzFor="purchaseCooldownSeconds">Purchase Cooldown (seconds)</nz-form-label>
        <nz-form-control [nzSpan]="24" [nzExtra]="purchaseCooldownExtra">
          <input formControlName="purchaseCooldownSeconds" nz-input name="purchaseCooldownSeconds" type="number"
            id="purchaseCooldownSeconds" />
        </nz-form-control>
      </nz-form-item>
      <ng-template #purchaseCooldownExtra>
        <p>Set a time in seconds to block the package after a purchase by the player. The player will be able to buy
          this package again once this time passes. Leave it blank if not needed.</p>
      </ng-template>

      <nz-form-item>
        <nz-form-label [nzSpan]="0" nzFor="stockPerPlayer">Stock Per Player</nz-form-label>
        <nz-form-control [nzSpan]="24" [nzExtra]="dailyPackageExtra">
          <input formControlName="stockPerPlayer" nz-input name="stockPerPlayer" type="number" id="stockPerPlayer" />
        </nz-form-control>
      </nz-form-item>
      <ng-template #dailyPackageExtra>
        <p>You can set how many times a player can buy this package per day.</p>
      </ng-template>

      <nz-form-item>
        <nz-form-label [nzSpan]="0" nzFor="stockPerVipPlayer">Stock Per Vip Player</nz-form-label>
        <nz-form-control [nzSpan]="24" [nzExtra]="dailyPackageExtra">
          <input formControlName="stockPerVipPlayer" nz-input name="stockPerVipPlayer" type="number" id="stockPerVipPlayer" />
        </nz-form-control>
      </nz-form-item>
      <ng-template #dailyPackageExtra>
        <p>You can set how many times a vip player can buy this package per day.</p>
      </ng-template>

      <nz-form-item>
        <nz-form-label [nzSpan]="0" nzFor="deliveryText">Package Delivery Message</nz-form-label>
        <nz-form-control [nzSpan]="24" [nzExtra]="packageDeliveryExtra">
          <input formControlName="deliveryText" nz-input name="deliveryText" type="text" id="deliveryText" />
        </nz-form-control>
      </nz-form-item>
      <ng-template #packageDeliveryExtra>
        <p style="margin: 0">Text that the bot will send in global chat after the package is delivered. Leave it blank
          for no text.</p>
        <p>You can use template variables for data reference like {{'{orderId}'}} {{'{playerName}'}}
          {{'{packageName}'}}.
        </p>
      </ng-template>

      <!-- <nz-form-item>
        <nz-form-label [nzSpan]="0" nzFor="commands">Commands</nz-form-label>
        <nz-form-control [nzSpan]="24" [nzExtra]="commandsExtra">
          <nz-input-group nzSearch nzSize="large" [nzAddOnAfter]="suffixButton">
            <input #command type="text" nz-input placeholder="Command or text" />
          </nz-input-group>
          <ng-template #suffixButton>
            <button nz-button nzType="primary" nzSize="large" nzSearch
              (click)="addComand(command.value); command.value = ''">
              Add
            </button>
          </ng-template>

          <div *ngIf="commands.length > 0">
            <nz-list style="margin-top: 20px;" nzBordered="true">
              @for (time of commands; track $index) {
              <nz-list-item>
                <p style="margin: 0;">{{time}}</p>
                <button style="height: 20px; width: 20px;" nz-button nzType="default" (click)="removeCommand($index)">
                  <nz-icon style="font-size: 10px;" nzType="close" />
                </button>
              </nz-list-item>
              }
            </nz-list>
          </div>
        </nz-form-control>
      </nz-form-item>
      <ng-template #commandsExtra>
        <p>You can add commands like #Announce to be executed or just a text. Text added here will be sent in the
          global
          chat. <span nz-typography nzType="danger">DO NOT USE IT TO SPAWN ITEMS.</span></p>
      </ng-template> -->
    </form>
  </nz-card>

  <nz-autocomplete (selectionChange)="autocompleteSelect($event)" [nzDataSource]="" nzBackfill #auto
    [nzDefaultActiveFirstOption]="true">
    @for (item of suggestions$ | async; track $index) {
    <nz-auto-option [nzLabel]="item.code + ' - ' + item.name" [nzValue]="item">{{item.code + ' - ' +
      item.name}}</nz-auto-option>
    }
  </nz-autocomplete>
  <nz-card nzTitle="Package Items">
    <form [formGroup]="packageItemForm" nz-form>
      <nz-form-item>
        <nz-form-label [nzSpan]="0" nzFor="searchControl">Item</nz-form-label>
        <nz-form-control [nzSpan]="24">
          <nz-input-group nzSearch nzSize="large" [nzAddOnAfter]="itemSuffixButton">
            <input formControlName="searchControl" type="text" [nzAutocomplete]="auto" nz-input
              placeholder="Please enter the item name or code" />
          </nz-input-group>
          <ng-template #itemSuffixButton>
            <button nz-button nzType="primary" nzSize="large" nzSearch (click)="addItem();">
              Add Item
            </button>
          </ng-template>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="0" nzFor="amount">Amount</nz-form-label>
        <nz-form-control [nzSpan]="24" [nzExtra]="ammountExtra">
          <input formControlName="amount" [placeholder]="!selectedItem ? 'Select a item first' : ''" nz-input
            name="amount" type="number" id="amount" />
        </nz-form-control>
      </nz-form-item>
      <ng-template #ammountExtra>
        <p style="margin: 0">The amount of the selected item that will be spawned.</p>
      </ng-template>

      <nz-form-item>
        <nz-form-label [nzSpan]="0" nzFor="vipPrice">Ammo Count</nz-form-label>
        <nz-form-control [nzSpan]="24" [nzExtra]="ammoCountExtra">
          <input formControlName="ammoCount" [placeholder]="!selectedItem ? 'Select a item first' : ''" nz-input
            name="amount" type="number" id="amount" />
        </nz-form-control>
      </nz-form-item>
      <ng-template #ammoCountExtra>
        <p style="margin: 0">The ammo count that will be loaded into the magazine. Only for magazines and clips!</p>
      </ng-template>

      <nz-table nzShowPagination="false" [nzData]="['']">
        <thead>
          <tr>
            <th>Name</th>
            <th>Amount</th>
            <th>Ammo Count</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          @for (item of items; track $index) {
          <tr>
            <td>{{item.itemName}}</td>
            <td>{{item.amount}}</td>
            <td>{{item.ammoCount}}</td>
            <td>
              <button nzSize="large" style="height: 20px; width: 20px;" [nzDanger]="true" nz-button nzType="link"
                (click)="removeItem(item.itemId)">
                <nz-icon style="font-size: 20px;" nzType="close" />
              </button>
            </td>
          </tr>
          }
        </tbody>
      </nz-table>
    </form>

  </nz-card>
</div>